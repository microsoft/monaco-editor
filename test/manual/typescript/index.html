<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	</head>
	<body>
		<h2>Monaco Editor TypeScript test page</h2>
		<button id="resetBtn">Reset Sample</button>
		<div id="container" style="width: 800px; height: 600px; border: 1px solid grey">
			<div id="div1" style="width: 800px; height: 250px; border: 1px solid grey"></div>
			<div id="div" style="width: 800px; height: 50px; border: 1px solid grey"></div>
			<div id="div2" style="width: 800px; height: 250px; border: 1px solid grey"></div>
		</div>
		<h3>Compiler settings</h3>
		<textarea style="font-family: monospace" id="compilerOpts" cols="60" rows="30"></textarea><br />
		<button id="updateCompilerSettingsBtn">Update compiler settings</button>

		<script src="../dev-setup.js"></script>
		<script>
			function getDefaultCode() {
				return ['function abc(){ }'].join('\n');
			}

			function getDefaultComplierOpts() {
				return { target: 99, jsx: 1, allowNonTsExtensions: true };
			}

			loadEditor(() => {
				monaco.languages.typescript.javascriptDefaults.addExtraLib(
					'declare function next() : string',
					'next.d.ts'
				);
				const editor = monaco.editor.create(document.getElementById('div1'), {
					value: localStorage.getItem('code') || getDefaultCode(),
					language: 'javascript'
				});

				const model1Uri = editor.getModel().uri.toString();

				const disposer = monaco.languages.typescript.javascriptDefaults.setInstanceLibs(model1Uri, [
					{ content: 'declare function model1() : string', filePath: 'model1.d.ts' }
				]);
				setTimeout(() => {
					const newModel = monaco.editor.createModel('new model', 'javascript');
					disposer.dispose();
					editor.setModel(newModel);
					const updateModel = editor.getModel().uri.toString();
					const disposer2 = monaco.languages.typescript.javascriptDefaults.setInstanceLibs(
						updateModel,
						[{ content: 'declare function newmodel() : string', filePath: 'newmodel.d.ts' }]
					);
				}, 10000);

				var editor2 = monaco.editor.create(document.getElementById('div2'), {
					value: localStorage.getItem('code') || getDefaultCode(),
					language: 'javascript'
				});
				let model2Uri = editor2.getModel().uri.toString();

				monaco.languages.typescript.javascriptDefaults.setInstanceLibs(model2Uri, [
					{ content: 'declare function model2() : string', filePath: 'model2.d.ts' }
				]);

				const optsString =
					localStorage.getItem('compiler-opts') ||
					JSON.stringify(getDefaultComplierOpts(), null, 4);
				document.getElementById('compilerOpts').textContent = optsString;
				monaco.languages.typescript.typescriptDefaults.setCompilerOptions(JSON.parse(optsString));

				document.getElementById('updateCompilerSettingsBtn').onclick = () => {
					const newOpts = document.getElementById('compilerOpts').value;
					monaco.languages.typescript.typescriptDefaults.setCompilerOptions(JSON.parse(newOpts));
					localStorage.setItem('compiler-opts', newOpts);
				};
			});
		</script>
	</body>
</html>
