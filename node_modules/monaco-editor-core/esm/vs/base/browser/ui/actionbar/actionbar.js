var __awaiter=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(o,n){function r(t){try{h(s.next(t))}catch(t){n(t)}}function a(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((s=s.apply(t,e||[])).next())}))};import*as DOM from"../../dom.js";import{StandardKeyboardEvent}from"../../keyboardEvent.js";import{ActionViewItem,BaseActionViewItem}from"./actionViewItems.js";import{ActionRunner,Separator}from"../../../common/actions.js";import{Emitter}from"../../../common/event.js";import{Disposable,DisposableMap,DisposableStore,dispose}from"../../../common/lifecycle.js";import*as types from"../../../common/types.js";import"./actionbar.css";export class ActionBar extends Disposable{constructor(t,e={}){var i,s,o,n,r,a;let h,c;switch(super(),this._actionRunnerDisposables=this._register(new DisposableStore),this.viewItemDisposables=this._register(new DisposableMap),this.triggerKeyDown=!1,this.focusable=!0,this._onDidBlur=this._register(new Emitter),this.onDidBlur=this._onDidBlur.event,this._onDidCancel=this._register(new Emitter({onWillAddFirstListener:()=>this.cancelHasListener=!0})),this.onDidCancel=this._onDidCancel.event,this.cancelHasListener=!1,this._onDidRun=this._register(new Emitter),this.onDidRun=this._onDidRun.event,this._onWillRun=this._register(new Emitter),this.onWillRun=this._onWillRun.event,this.options=e,this._context=null!==(i=e.context)&&void 0!==i?i:null,this._orientation=null!==(s=this.options.orientation)&&void 0!==s?s:0,this._triggerKeys={keyDown:null!==(n=null===(o=this.options.triggerKeys)||void 0===o?void 0:o.keyDown)&&void 0!==n&&n,keys:null!==(a=null===(r=this.options.triggerKeys)||void 0===r?void 0:r.keys)&&void 0!==a?a:[3,10]},this.options.actionRunner?this._actionRunner=this.options.actionRunner:(this._actionRunner=new ActionRunner,this._actionRunnerDisposables.add(this._actionRunner)),this._actionRunnerDisposables.add(this._actionRunner.onDidRun((t=>this._onDidRun.fire(t)))),this._actionRunnerDisposables.add(this._actionRunner.onWillRun((t=>this._onWillRun.fire(t)))),this.viewItems=[],this.focusedItem=void 0,this.domNode=document.createElement("div"),this.domNode.className="monaco-action-bar",!1!==e.animated&&this.domNode.classList.add("animated"),this._orientation){case 0:h=[15],c=[17];break;case 1:h=[16],c=[18],this.domNode.className+=" vertical"}this._register(DOM.addDisposableListener(this.domNode,DOM.EventType.KEY_DOWN,(t=>{const e=new StandardKeyboardEvent(t);let i=!0;const s="number"==typeof this.focusedItem?this.viewItems[this.focusedItem]:void 0;h&&(e.equals(h[0])||e.equals(h[1]))?i=this.focusPrevious():c&&(e.equals(c[0])||e.equals(c[1]))?i=this.focusNext():e.equals(9)&&this.cancelHasListener?this._onDidCancel.fire():e.equals(14)?i=this.focusFirst():e.equals(13)?i=this.focusLast():e.equals(2)&&s instanceof BaseActionViewItem&&s.trapsArrowNavigation?i=this.focusNext():this.isTriggerKeyEvent(e)?this._triggerKeys.keyDown?this.doTrigger(e):this.triggerKeyDown=!0:i=!1,i&&(e.preventDefault(),e.stopPropagation())}))),this._register(DOM.addDisposableListener(this.domNode,DOM.EventType.KEY_UP,(t=>{const e=new StandardKeyboardEvent(t);this.isTriggerKeyEvent(e)?(!this._triggerKeys.keyDown&&this.triggerKeyDown&&(this.triggerKeyDown=!1,this.doTrigger(e)),e.preventDefault(),e.stopPropagation()):(e.equals(2)||e.equals(1026))&&this.updateFocusedItem()}))),this.focusTracker=this._register(DOM.trackFocus(this.domNode)),this._register(this.focusTracker.onDidBlur((()=>{DOM.getActiveElement()!==this.domNode&&DOM.isAncestor(DOM.getActiveElement(),this.domNode)||(this._onDidBlur.fire(),this.focusedItem=void 0,this.previouslyFocusedItem=void 0,this.triggerKeyDown=!1)}))),this._register(this.focusTracker.onDidFocus((()=>this.updateFocusedItem()))),this.actionsList=document.createElement("ul"),this.actionsList.className="actions-container",this.actionsList.setAttribute("role",this.options.ariaRole||"toolbar"),this.options.ariaLabel&&this.actionsList.setAttribute("aria-label",this.options.ariaLabel),this.domNode.appendChild(this.actionsList),t.appendChild(this.domNode)}refreshRole(){this.length()>=2?this.actionsList.setAttribute("role",this.options.ariaRole||"toolbar"):this.actionsList.setAttribute("role","presentation")}setFocusable(t){if(this.focusable=t,this.focusable){const t=this.viewItems.find((t=>t instanceof BaseActionViewItem&&t.isEnabled()));t instanceof BaseActionViewItem&&t.setFocusable(!0)}else this.viewItems.forEach((t=>{t instanceof BaseActionViewItem&&t.setFocusable(!1)}))}isTriggerKeyEvent(t){let e=!1;return this._triggerKeys.keys.forEach((i=>{e=e||t.equals(i)})),e}updateFocusedItem(){for(let t=0;t<this.actionsList.children.length;t++){const e=this.actionsList.children[t];if(DOM.isAncestor(DOM.getActiveElement(),e)){this.focusedItem=t;break}}}get context(){return this._context}set context(t){this._context=t,this.viewItems.forEach((e=>e.setActionContext(t)))}get actionRunner(){return this._actionRunner}set actionRunner(t){this._actionRunner=t,this._actionRunnerDisposables.clear(),this._actionRunnerDisposables.add(this._actionRunner.onDidRun((t=>this._onDidRun.fire(t)))),this._actionRunnerDisposables.add(this._actionRunner.onWillRun((t=>this._onWillRun.fire(t)))),this.viewItems.forEach((e=>e.actionRunner=t))}getContainer(){return this.domNode}getAction(t){var e;if("number"==typeof t)return null===(e=this.viewItems[t])||void 0===e?void 0:e.action;if(t instanceof HTMLElement){for(;t.parentElement!==this.actionsList;){if(!t.parentElement)return;t=t.parentElement}for(let e=0;e<this.actionsList.childNodes.length;e++)if(this.actionsList.childNodes[e]===t)return this.viewItems[e].action}}push(t,e={}){const i=Array.isArray(t)?t:[t];let s=types.isNumber(e.index)?e.index:null;i.forEach((t=>{const i=document.createElement("li");let o;i.className="action-item",i.setAttribute("role","presentation");const n=Object.assign({hoverDelegate:this.options.hoverDelegate},e);this.options.actionViewItemProvider&&(o=this.options.actionViewItemProvider(t,n)),o||(o=new ActionViewItem(this.context,t,n)),this.options.allowContextMenu||this.viewItemDisposables.set(o,DOM.addDisposableListener(i,DOM.EventType.CONTEXT_MENU,(t=>{DOM.EventHelper.stop(t,!0)}))),o.actionRunner=this._actionRunner,o.setActionContext(this.context),o.render(i),this.focusable&&o instanceof BaseActionViewItem&&0===this.viewItems.length&&o.setFocusable(!0),null===s||s<0||s>=this.actionsList.children.length?(this.actionsList.appendChild(i),this.viewItems.push(o)):(this.actionsList.insertBefore(i,this.actionsList.children[s]),this.viewItems.splice(s,0,o),s++)})),"number"==typeof this.focusedItem&&this.focus(this.focusedItem),this.refreshRole()}clear(){this.isEmpty()||(this.viewItems=dispose(this.viewItems),this.viewItemDisposables.clearAndDisposeAll(),DOM.clearNode(this.actionsList),this.refreshRole())}length(){return this.viewItems.length}isEmpty(){return 0===this.viewItems.length}focus(t){let e,i=!1;if(void 0===t?i=!0:"number"==typeof t?e=t:"boolean"==typeof t&&(i=t),i&&void 0===this.focusedItem){const t=this.viewItems.findIndex((t=>t.isEnabled()));this.focusedItem=-1===t?void 0:t,this.updateFocus(void 0,void 0,!0)}else void 0!==e&&(this.focusedItem=e),this.updateFocus(void 0,void 0,!0)}focusFirst(){return this.focusedItem=this.length()-1,this.focusNext(!0)}focusLast(){return this.focusedItem=0,this.focusPrevious(!0)}focusNext(t){if(void 0===this.focusedItem)this.focusedItem=this.viewItems.length-1;else if(this.viewItems.length<=1)return!1;const e=this.focusedItem;let i;do{if(!t&&this.options.preventLoopNavigation&&this.focusedItem+1>=this.viewItems.length)return this.focusedItem=e,!1;this.focusedItem=(this.focusedItem+1)%this.viewItems.length,i=this.viewItems[this.focusedItem]}while(this.focusedItem!==e&&(this.options.focusOnlyEnabledItems&&!i.isEnabled()||i.action.id===Separator.ID));return this.updateFocus(),!0}focusPrevious(t){if(void 0===this.focusedItem)this.focusedItem=0;else if(this.viewItems.length<=1)return!1;const e=this.focusedItem;let i;do{if(this.focusedItem=this.focusedItem-1,this.focusedItem<0){if(!t&&this.options.preventLoopNavigation)return this.focusedItem=e,!1;this.focusedItem=this.viewItems.length-1}i=this.viewItems[this.focusedItem]}while(this.focusedItem!==e&&(this.options.focusOnlyEnabledItems&&!i.isEnabled()||i.action.id===Separator.ID));return this.updateFocus(!0),!0}updateFocus(t,e,i=!1){var s;void 0===this.focusedItem&&this.actionsList.focus({preventScroll:e}),void 0!==this.previouslyFocusedItem&&this.previouslyFocusedItem!==this.focusedItem&&(null===(s=this.viewItems[this.previouslyFocusedItem])||void 0===s||s.blur());const o=void 0!==this.focusedItem&&this.viewItems[this.focusedItem];if(o){let s=!0;types.isFunction(o.focus)||(s=!1),this.options.focusOnlyEnabledItems&&types.isFunction(o.isEnabled)&&!o.isEnabled()&&(s=!1),o.action.id===Separator.ID&&(s=!1),s?(i||this.previouslyFocusedItem!==this.focusedItem)&&(o.focus(t),this.previouslyFocusedItem=this.focusedItem):(this.actionsList.focus({preventScroll:e}),this.previouslyFocusedItem=void 0)}}doTrigger(t){if(void 0===this.focusedItem)return;const e=this.viewItems[this.focusedItem];if(e instanceof BaseActionViewItem){const i=null===e._context||void 0===e._context?t:e._context;this.run(e._action,i)}}run(t,e){return __awaiter(this,void 0,void 0,(function*(){yield this._actionRunner.run(t,e)}))}dispose(){this._context=void 0,this.viewItems=dispose(this.viewItems),this.getContainer().remove(),super.dispose()}}